name: Production CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 mypy
        pip install -e ".[dev]"
    
    - name: Lint with flake8
      run: |
        flake8 ingesta --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 ingesta --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
    
    - name: Format check with black
      run: |
        black --check ingesta tests || true
    
    - name: Type check with mypy
      run: |
        mypy ingesta --ignore-missing-imports || true

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install FFmpeg (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: Install FFmpeg (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install ffmpeg
    
    - name: Install package
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Test CLI help works
      run: |
        ingesta --help
    
    - name: Test import without optional deps
      run: |
        python -c "from ingesta import ingest_media, IngestionJob; print('Core imports work')"
    
    - name: Run unit tests
      run: |
        pytest tests/ -v --tb=short
    
    - name: Test ingest workflow
      run: |
        mkdir -p test_workflow/source test_workflow/dest1 test_workflow/dest2
        echo "test content" > test_workflow/source/test.txt
        ingesta ingest --source test_workflow/source --dest test_workflow/dest1 --dest test_workflow/dest2 --checksum md5
        test -f test_workflow/dest1/test.txt
        test -f test_workflow/dest2/test.txt
        echo "âœ“ Multi-destination ingest works"
    
    - name: Test report generation
      run: |
        mkdir -p test_workflow/reports
        ffmpeg -f lavfi -i testsrc=duration=1:size=320x240:rate=30 -pix_fmt yuv420p test_workflow/source/video.mp4 -y || true
        ingesta report --media-dir test_workflow/source --output-dir test_workflow/reports --format csv || true
    
    - name: Cleanup test files
      run: |
        rm -rf test_workflow

  install-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Test clean install
      run: |
        python -m pip install --upgrade pip
        pip install .
        ingesta --version
        ingesta --help
    
    - name: Test install from PyPI (if published)
      if: github.event_name == 'release'
      run: |
        pip install ingesta
        ingesta --version